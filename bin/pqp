#!/bin/bash
# echo "energos was here..."
# echo "$1 | $2 | $3 | $4 | $5 | $6"
# exit

TERMINAL=urxvtcd
ICONS=$HOME/.local/share/icons
HIDEDESKTOP=4

urxvtcd ()
{
    urxvtc 2> /dev/null "$@" || (urxvtd -q -f && urxvtc "$@")
}

show_window ()
# show_window (CLASS DESKTOP)
#
# Search for a window of class CLASS and activate or hide it.
#
# if WINDOWS is in this desktop
#    if active then hide
#    else activate
# else
#    if WINDOWS is in 'other' desktop then bring it to this desktop and activate it
#    else return 1
# return 0
#
# search 'other' desktop: If DESKTOP is 0, search all desktops
#                         If DESKTOP is HIDEDESKTOP, search only HIDEDESKTOP
#
{
    [[ $force_new == 1 ]] && return 1

    CLASS=$1
    DESKTOP=$(xdotool get_desktop)

    WINDOW=$(xdotool search --desktop $DESKTOP --classname ^$CLASS$ | head -n 1)
    if [[ -n  $WINDOW ]]
    then
        if echo $WINDOW | grep -q ^$(xdotool getactivewindow)$ || xprop _NET_WM_STATE -id $WINDOW | grep -q _NET_WM_STATE_ABOVE
        then
            # echo "$WINDOW is ACTIVE so we HIDE it" > /dev/pts/7
            xdotool set_desktop_for_window $WINDOW $HIDEDESKTOP
        else
            # echo "$WINDOW is NOT ACTIVE so we SHOW it" > /dev/pts/7
            xdotool windowactivate $WINDOW
        fi
    else
        WINDOW=$(for i in $(seq $2 $HIDEDESKTOP); do xdotool search --desktop $i --classname ^$CLASS$; done | head -n 1)
        if [[ -n  $WINDOW ]]
        then
            # echo "$WINDOW is in 'OTHER' DESKTOP so we BRING it BACK" > /dev/pts/7
            xdotool set_desktop_for_window $WINDOW $DESKTOP
            xprop _NET_WM_STATE -id $WINDOW | grep -q _NET_WM_STATE_ABOVE || xdotool windowactivate $WINDOW
        else
            # echo "Zero, zilch, zip, nada, nothing." > /dev/pts/7
            return 1
        fi
    fi
    return 0
}

# contorno o fato de gmrun enfiar tudo em $1
set -- $@

# default is to search for CLASS in existent windows
force_new=0

# parse options
while getopts ":n" option; do
    case $option in
        n)  # echo "N" > /dev/pts/7
            # abort search and run a new program instance
            force_new=1
            ;;
        \?) # echo "${0##*/}: Invalid option -$OPTARG" > /dev/pts/7
            ;;
    esac
done
shift $((OPTIND - 1))

case "$1" in
    "")
        show_window Terminal $HIDEDESKTOP || $TERMINAL -name Terminal
        ;;
    "emacs")
        show_window Emacs $HIDEDESKTOP || emacsclient -c -n -a "emacs" 2> /dev/null &
        ;;
    "firefox")
        show_window Navigator $HIDEDESKTOP || firefox &> /dev/null &
        ;;
    "mc")
        $TERMINAL -icon $ICONS/mc.svg -title "Midnight Commander" -sl 0 -geometry 96x48 -e $@ -d
        ;;
    "gkrellm")
        show_window Gkrellm 0 || gkrellm &
        ;;
    "cmus")
        show_window cmusMusicPlayer 0 || urxvtcd -icon $ICONS/Audio-x-generic.svg -name cmusMusicPlayer -sl 0 -geometry 80x18-0+0 -e cmus
        ;;
    "pdf")
        show_window Zathura $HIDEDESKTOP || zathura ~/default.pdf &
        ;;
    "man")
        $TERMINAL -icon $ICONS/Blue_question_mark_icon.svg -title "$*" -bl -sl 0 -geometry +0+0 -e sh -c "$* || read -n 1 -s -p 'Press any key to exit!'" && sleep 0.05 && wmctrl -r :ACTIVE: -b add,maximized_vert &
        ;;
    "info")
        $TERMINAL -icon $ICONS/Blue_question_mark_icon.svg -title "$*" -sl 0 -geometry +458+0 -e $@ && sleep 0.05 && wmctrl -r :ACTIVE: -b add,maximized_vert &
        ;;
    "help")
        $TERMINAL -icon $ICONS/Blue_question_mark_icon.svg -title "$*" -sl 0 -geometry +458+0 -e sh -c "$* | less"
        ;;
    "logs")
        brocket -a freakingLogs
        ;;
    "mrxvt")
        LANG="en_US.ISO-8859-1" mrxvt -stt -profile0.tabTitle "terminal (ISO-8859-1)" &
        ;;
    "res")
        case "$2" in
            "1")
                # SCALE 1
                xrandr --output DisplayPort-0 --auto --pos 0x0 --output HDMI-0 --auto --panning 1920x1080+3840+1080 --scale 1x1 --pos 3840x1080
                # Sometimes it doesn't work on the first try...
                sleep 0.5
                xrandr --output DisplayPort-0 --auto --pos 0x0 --output HDMI-0 --auto --panning 1920x1080+3840+1080 --scale 1x1 --pos 3840x1080
                ;;
            "2")
                # SCALE 1.5
                xrandr --output DisplayPort-0 --auto --pos 0x0 --output HDMI-0 --auto --panning 2880x1620+3840+540 --scale 1.5x1.5 --pos 3840x540
                # Sometimes it doesn't work on the first try...
                sleep 0.5
                xrandr --output DisplayPort-0 --auto --pos 0x0 --output HDMI-0 --auto --panning 2880x1620+3840+540 --scale 1.5x1.5 --pos 3840x540
                ;;
            *)
                # SCALE 1.65
                xrandr --output DisplayPort-0 --auto --pos 0x0 --output HDMI-0 --auto --panning 3168x1782+3840+220 --scale 1.65x1.65 --pos 3840x220
                # Sometimes it doesn't work on the first try...
                sleep 0.5
                xrandr --output DisplayPort-0 --auto --pos 0x0 --output HDMI-0 --auto --panning 3168x1782+3840+220 --scale 1.65x1.65 --pos 3840x220
                ;;
        esac
        ;;
    "ww")
        # set active window width
        # ugly hack to give gmrum time to shut off
        (sleep 0.01 && wmctrl -r :ACTIVE: -e 0,-1,-1,$2,-1) &
        ;;
    "wh")
        # set active window height
        # ugly hack to give gmrum time to shut off
        (sleep 0.01 && wmctrl -r :ACTIVE: -e 0,-1,-1,-1,$2) &
        ;;
    *)
        $TERMINAL -title "$*" -e $@
esac
