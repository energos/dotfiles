#!/bin/bash

# https://superuser.com/questions/418699/
DPI=$(xdpyinfo | awk -F'[ x]+' '/resolution:/{print $3}')

THRESHOLD=${THRESHOLD:-120}
[[ $DPI -gt $THRESHOLD ]] && HDPI="-DHIGH_DPI" || HDPI=""
xrdb $HDPI -DXSERVER_DPI=$DPI ~/.Xresources

# xrandr --output VGA-1 --mode 1024x1280 --pos 0x0 --output VGA-2 --mode 1920x1080 --pos 1024x200 --output VGA-3 --mode 1280x1024 --pos 2944x256
# xrandr --output DVI-0 --pos 0x0 --rotate left --output HDMI-0 --pos 1024x200 --output DVI-1 --pos 2944x256

# Comment next line for single monitor setup
# pqp res 2 # scale left monitor to 1.5

# Get configured console keymap from /etc/conf.d/keymaps and set X keymap accordingly
eval $(grep ^keymap= /etc/conf.d/keymaps)
case "$keymap" in
    br-abnt2)
        setxkbmap -model abnt2,pc104 -layout br,us -variant abnt2,intl -option -option grp:shifts_toggle,grp_led:caps,terminate:ctrl_alt_bksp,caps:none,lv3:ralt_switch_multikey
        ;;
    pt-latin1)
        setxkbmap -model pc105 -layout pt,us -variant basic,intl -option -option grp:shifts_toggle,grp_led:caps,terminate:ctrl_alt_bksp,caps:none,lv3:ralt_switch_multikey
        ;;
    *)
        setxkbmap -model pc104 -layout us,us -variant intl,basic -option -option grp:shifts_toggle,grp_led:caps,terminate:ctrl_alt_bksp,caps:none,lv3:ralt_switch_multikey
        ;;
esac
xmodmap -e 'keycode 66 = F13'   # Remap Caps_Lock
xmodmap -e 'keycode 78 = F14'   # Remap Scroll_Lock
xmodmap -e 'keycode 127 = F15'  # Remap Pause
xmodmap -e 'keycode 77 = F15'   # Remap Num_Lock

export QT_QPA_PLATFORMTHEME=qt5ct

if [[ $(cat /sys/devices/virtual/dmi/id/product_name) == "VirtualBox" ]]
then
    # If host is a VirtualBox guest
    # run Guest Additions client
    [[ -x $(command -v VBoxClient-all) ]] && VBoxClient-all
    # turn off screensaver
    xset s off -dpms
else
    # If host is not a VirtualBox guest
    # start a synergy server or connect to a existing one
    SYNERGY_SERVER=speedy
    [[ $(hostname) == $SYNERGY_SERVER ]] && synergys || synergyc $SYNERGY_SERVER
fi

# Call wicd-client if wicd daemon is running
[[ -x /etc/init.d/wicd ]] && /etc/init.d/wicd status &> /dev/null && (wicd-client &> /dev/null &)

exec openbox-session
# exec startkde
# exec twm
# exec icewm-session
